{% extends "base.html" %}
{% block content %}
<h2 class="mb-3">Result</h2>

<h5>Input (JSON)</h5>
<pre class="bg-white p-3 border rounded">{{ raw_input }}</pre>

{% if allocation %}
  <h5 class="mt-4">Allocation (output)</h5>
  <pre class="bg-white p-3 border rounded">{{ allocation|tojson(indent=2) }}</pre>

  <!-- Item Details Table -->
  {% if item_details %}
  <h5 class="mt-4">Item Details & Allocations</h5>
  <div class="table-responsive">
    <table class="table table-striped table-bordered table-hover">
      <thead class="table-dark">
        <tr>
          <th>Item</th>
          <th>Category</th>
          {% for agent in agents %}
          <th>Value ({{ agent }})</th>
          {% endfor %}
          <th>Allocated To</th>
        </tr>
      </thead>
      <tbody>
        {% for detail in item_details %}
        <tr>
          <td><strong><code>{{ detail.item }}</code></strong></td>
          <td><span class="badge bg-secondary">{{ detail.category }}</span></td>
          {% for agent in agents %}
          <td class="text-end {% if detail.agent_values[agent] < 0 %}text-danger{% elif detail.agent_values[agent] > 0 %}text-success{% else %}text-muted{% endif %}">
            {{ "%.2f"|format(detail.agent_values[agent]) }}
          </td>
          {% endfor %}
          <td class="text-center">
            {% if detail.allocated_to %}
            <span class="badge bg-primary">{{ detail.allocated_to }}</span>
            {% else %}
            <span class="badge bg-warning text-dark">Unallocated</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- EF11 Analysis Section -->
  {% if ef11_result %}
  <h5 class="mt-4">EF[1,1] Analysis</h5>
  <div class="card mb-3">
    <div class="card-header bg-primary text-white">
      <h6 class="mb-0">Fairness Analysis Results</h6>
    </div>
    <div class="card-body">

      <!-- Bundle Values -->
      <h6 class="mt-3">Bundle Valuations</h6>
      <div class="row">
        {% for agent, values in ef11_result.bundle_values.items() %}
        <div class="col-md-6 mb-3">
          <div class="card">
            <div class="card-header bg-light">
              <strong>{{ agent }}</strong>
            </div>
            <div class="card-body">
              <table class="table table-sm table-bordered mb-0">
                <tr>
                  <td><strong>Own Bundle Value:</strong></td>
                  <td class="text-end">{{ "%.2f"|format(values.own_bundle_value) }}</td>
                </tr>
                <tr>
                  <td><strong>Other Bundle Value:</strong></td>
                  <td class="text-end">{{ "%.2f"|format(values.other_bundle_value) }}</td>
                </tr>
                <tr>
                  <td><strong>Gap:</strong></td>
                  <td class="text-end"><strong>{{ "%.2f"|format(values.gap) }}</strong></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Swap Pairs -->
      {% for agent, swaps in ef11_result.swap_pairs.items() %}
        {% if swaps %}
        <h6 class="mt-4">Potential Item Pair Removals for {{ agent }}</h6>
        <div class="table-responsive">
          <table class="table table-sm table-striped table-bordered">
            <thead class="table-light">
              <tr>
                <th>Category</th>
                <th>Remove from Own Bundle</th>
                <th>Value (Chore)</th>
                <th>Remove from Other Bundle</th>
                <th>Value (Good)</th>
                <th>Total Gain</th>
                <th>Eliminates Envy</th>
              </tr>
            </thead>
            <tbody>
              {% for swap in swaps %}
              <tr>
                <td><strong>{{ swap.category }}</strong></td>
                <td><code>{{ swap.remove_from_own }}</code></td>
                <td class="text-end">{{ "%.2f"|format(swap.chore_value) }}</td>
                <td><code>{{ swap.remove_from_other }}</code></td>
                <td class="text-end">{{ "%.2f"|format(swap.good_value) }}</td>
                <td class="text-end"><strong>{{ "%.2f"|format(swap.total_gain) }}</strong></td>
                <td class="text-center">
                  {{ swap.eliminates_envy }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      {% endfor %}

      {% if not ef11_result.swap_pairs.values()|selectattr('length')|list %}
      <div class="alert alert-info mt-3">
        No swap pairs identified.
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

{% else %}
  <h5 class="mt-4 text-danger">No allocation returned</h5>
{% endif %}

<h5 class="mt-4">Algorithm Log</h5>
<pre class="bg-white p-3 border rounded" style="white-space: pre-wrap">{{ logs }}</pre>

<a class="btn btn-secondary mt-4" href="{{ url_for('demo') }}">Run another instance</a>

{% endblock %}